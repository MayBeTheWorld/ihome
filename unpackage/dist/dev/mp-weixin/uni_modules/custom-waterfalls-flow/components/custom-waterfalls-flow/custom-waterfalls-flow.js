"use strict";const l=require("../../../../common/vendor.js"),o={props:{value:Array,column:{type:[String,Number],default:2},maxColumn:{type:[String,Number],default:5},columnSpace:{type:[String,Number],default:2},imageKey:{type:[String],default:"image"},hideImageKey:{type:[String],default:"hide"},seat:{type:[String,Number],default:2},listStyle:{type:Object}},data(){return{data:{list:this.value?this.value:[],column:this.column<2?2:this.column,columnSpace:this.columnSpace<=5?this.columnSpace:5,imageKey:this.imageKey,seat:this.seat},msg:0,listInitStyle:{"border-radius":"12rpx","margin-bottom":"20rpx","background-color":"#fff"},adds:[],isLoaded:!0,curIndex:0,isRefresh:!0,flag:!1,refreshDatas:[]}},computed:{w(){return`${100/this.data.column-+this.data.columnSpace}%`},m(){return`${(100-(100/this.data.column-+this.data.columnSpace).toFixed(5)*this.data.column)/(this.data.column-1)}%`},s1(){return{...this.listInitStyle,...this.listStyle}}},created(){this.refresh()},methods:{loadImages(t=0){let e=0;const s=this.data.list.filter((i,a)=>a>=t);for(let i=0;i<s.length;i++)l.index.getImageInfo({src:`${s[i][this.imageKey]}.jpg`,complete:a=>{e++,e==s.length&&this.initValue(t)}})},refresh(){if(!this.isLoaded)return this.refreshDatas=this.value,!1;setTimeout(()=>{this.refreshDatas=[],this.isRefresh=!0,this.adds=[],this.data.list=this.value?this.value:[],this.data.column=this.column<2?2:this.column>=this.maxColumn?this.maxColumn:this.column,this.data.columnSpace=this.columnSpace<=5?this.columnSpace:5,this.data.imageKey=this.imageKey,this.data.seat=this.seat,this.curIndex=0;for(let t=1;t<=this.data.column;t++)this.data[`column_${t}_values`]=[],this.msg++;this.$nextTick(()=>{this.initValue(this.curIndex,"refresh==>")})},1)},columnValue(t){return this.data[`column_${t+1}_values`]},change(t){for(let e=0;e<this.data.list.length;e++){const s=this.data[`column_${this.data.list[e].column}_values`];for(let i=0;i<s.length;i++)if(t[e]&&e===s[i].index){this.data[`column_${this.data.list[e].column}_values`][i]=Object.assign(s[i],t[e]),this.msg++;break}}},getMin(t,e){let s=t[0][e],i=t[0];for(var a=t.length-1;a>=0;a--)t[a][e]<s&&(s=t[a][e]);return i=t.filter(n=>n[e]==s),i[0]},getMinColumnHeight(){return new Promise(t=>{const e=[];for(let s=1;s<=this.data.column;s++)l.index.createSelectorQuery().in(this).select(`#waterfalls_flow_column_${s}`).boundingClientRect(a=>{e.push({column:s,height:a.height})}).exec(()=>{this.data.column<=e.length&&t(this.getMin(e,"height"))})})},async initValue(t,e){if(this.isLoaded=!1,t>=this.data.list.length||this.refreshDatas.length)return this.msg++,this.loaded(),!1;const s=await this.getMinColumnHeight(),i=this.data[`column_${s.column}_values`];this.data.list[t].column=s.column,i.push({...this.data.list[t],cIndex:i.length,index:t,o:0}),this.msg++},imgLoad(t,e){const s=t.index;t.o=1,this.$set(this.data[`column_${e}_values`],t.cIndex,JSON.parse(JSON.stringify(t))),this.initValue(s+1)},imgError(t,e){const s=t.index;t.o=1,t[this.data.imageKey]=null,this.$set(this.data[`column_${e}_values`],t.cIndex,JSON.parse(JSON.stringify(t))),this.initValue(s+1)},loaded(){if(this.refreshDatas.length)return this.isLoaded=!0,this.refresh(),!1;this.curIndex=this.data.list.length,this.adds.length?(this.data.list=this.adds[0],this.adds.splice(0,1),this.initValue(this.curIndex)):(this.data.list.length&&this.$emit("loaded"),this.isLoaded=!0,this.isRefresh=!1)},wapperClick(t){this.$emit("wapperClick",t)},imageClick(t){this.$emit("imageClick",t)}},watch:{value:{deep:!0,handler(t,e){setTimeout(()=>{this.$nextTick(()=>{if(this.isRefresh)return!1;if(this.isLoaded){if(t.length<=this.curIndex)return this.change(t);this.data.list=t,this.$nextTick(()=>{this.initValue(this.curIndex,"watch==>")})}else this.adds.push(t)})},10)}},column(t){this.refresh()}}};function d(t,e,s,i,a,n){return{a:l.f(a.data.column,(f,r,g)=>({a:l.f(n.columnValue(r),(h,u,_)=>l.e(a.data.seat==1?{a:l.d(`slot${h.index}`)}:{},{b:l.n({"img-hide":h[s.hideImageKey]==!0||h[s.hideImageKey]==1}),c:l.n({"img-error":!h[a.data.imageKey]}),d:h[a.data.imageKey],e:l.o(c=>n.imgLoad(h,r+1),u),f:l.o(c=>n.imgError(h,r+1),u),g:l.o(c=>n.imageClick(h),u)},a.data.seat==2?{h:l.d(`slot${h.index}`)}:{},{i:l.n({"column-value-show":h.o}),j:u,k:l.o(c=>n.wapperClick(h),u)})),b:r,c:`waterfalls_flow_column_${r+1}`,d:r==0?0:n.m})),b:a.data.seat==1,c:a.data.seat==2,d:l.s(n.s1),e:a.msg,f:n.w}}const m=l._export_sfc(o,[["render",d],["__scopeId","data-v-6aaf0fae"],["__file","D:/Projects/爱佳装/uni_modules/custom-waterfalls-flow/components/custom-waterfalls-flow/custom-waterfalls-flow.vue"]]);wx.createComponent(m);
